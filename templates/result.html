{% extends "navsidebar.html" %}

{% block title %}
    MediPredict | Prediction Results
{% endblock title %}

{% block style %}

    :root {
        --primary: #4a6cf7;
        --primary-dark: #3a5ce5;
        --primary-light: #6b8cff;
        --secondary: #764ba2;
        --accent: #00d4ff;
        --dark: #1a1a2e;
        --light: #f8fafc;
        --gray: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
    }

    /* ==================== PAGE HEADER ==================== */
    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 1.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: 10%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
    }

    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .page-header p {
        margin: 0.5rem 0 0;
        opacity: 0.9;
    }

    .results-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 0.75rem 1.25rem;
        border-radius: 50px;
        font-weight: 600;
    }

    .results-badge i {
        font-size: 1.25rem;
    }

    /* ==================== FILTER CARD ==================== */
    .filter-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: visible;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 10;
    }

    .filter-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filter-card-header i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .filter-card-header h5 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .filter-card-body {
        padding: 1.5rem;
        overflow: visible;
    }

    /* Filter Tags */
    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 36px;
        margin-bottom: 1rem;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, rgba(74, 108, 247, 0.1), rgba(118, 75, 162, 0.1));
        color: var(--primary);
        border: 1px solid rgba(74, 108, 247, 0.2);
        border-radius: 50px;
        padding: 0.375rem 0.75rem 0.375rem 1rem;
        font-size: 0.8rem;
        font-weight: 600;
        animation: tagAppear 0.3s ease;
    }

    @keyframes tagAppear {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .filter-tag-remove {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(74, 108, 247, 0.2);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-tag-remove:hover {
        background: var(--danger);
        color: white;
    }

    .filter-tag-remove i {
        font-size: 0.875rem;
    }

    /* Filter Grid - 5 columns for demand level */
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        position: relative;
    }

    @media (max-width: 1400px) {
        .filter-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 992px) {
        .filter-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Searchable Dropdown */
    .searchable-dropdown {
        position: relative;
        z-index: 1;
    }

    .searchable-dropdown:focus-within,
    .searchable-dropdown.open {
        z-index: 9999;
    }

    .searchable-dropdown .dropdown-toggle {
        width: 100%;
        padding: 0.75rem 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        color: var(--dark);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
    }

    .searchable-dropdown .dropdown-toggle:hover {
        border-color: var(--primary);
    }

    .searchable-dropdown .dropdown-toggle:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        outline: none;
    }

    .searchable-dropdown .dropdown-toggle::after {
        content: '\e5cf';
        font-family: 'Material Icons';
        font-size: 1.25rem;
        color: var(--gray);
        transition: transform 0.3s ease;
    }

    .searchable-dropdown .dropdown-toggle.active::after {
        transform: rotate(180deg);
    }

    .searchable-dropdown .selected-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

    .searchable-dropdown .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        margin-top: 0.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        display: none;
        max-height: 300px;
        overflow: hidden;
    }

    .searchable-dropdown .dropdown-menu.show {
        display: block;
        animation: dropdownFade 0.2s ease;
    }

    @keyframes dropdownFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .searchable-dropdown .dropdown-search-container {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .searchable-dropdown .dropdown-search {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.3s ease;
    }

    .searchable-dropdown .dropdown-search:focus {
        outline: none;
        border-color: var(--primary);
    }

    .searchable-dropdown .dropdown-options {
        max-height: 220px;
        overflow-y: auto;
    }

    .searchable-dropdown .dropdown-option {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 0.9rem;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .searchable-dropdown .dropdown-option:hover {
        background-color: #f8fafc;
    }

    .searchable-dropdown .dropdown-option.selected {
        background: linear-gradient(135deg, rgba(74, 108, 247, 0.1), rgba(118, 75, 162, 0.1));
        color: var(--primary);
        font-weight: 600;
    }

    .searchable-dropdown .dropdown-option.all-option {
        font-weight: 600;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    .searchable-dropdown .dropdown-option.empty {
        color: var(--gray);
        font-style: italic;
        text-align: center;
        padding: 1rem;
    }

    /* Demand Level Option Badges */
    .demand-option-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .demand-option-badge.high {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
    }

    .demand-option-badge.medium {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
    }

    .demand-option-badge.low {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
    }

    /* Filter Actions */
    .filter-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .btn-reset {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-reset:hover {
        border-color: var(--danger);
        color: var(--danger);
        background: rgba(239, 68, 68, 0.05);
    }

    .btn-reset i {
        font-size: 1.1rem;
    }

    .filter-count {
        font-size: 0.875rem;
        color: var(--gray);
    }

    .filter-count strong {
        color: var(--primary);
    }

    /* ==================== TABLE CARD ==================== */
    .table-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .table-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .table-card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .table-card-title i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .table-card-title h5 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .table-card-body {
        padding: 1.5rem;
    }

    /* Pagination Controls */
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination-control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray);
    }

    .pagination-select {
        padding: 0.5rem 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--dark);
        background: white;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }

    .pagination-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    /* Table Styles */
    .predictions-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .predictions-table thead th {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
    }

    .predictions-table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        font-size: 0.9rem;
        color: var(--dark);
    }

    .predictions-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .predictions-table tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Table Badges */
    .badge-brand {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        background: linear-gradient(135deg, rgba(100, 116, 139, 0.1), rgba(100, 116, 139, 0.15));
        color: var(--gray);
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-category {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(6, 182, 212, 0.15));
        color: var(--info);
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-none {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        background: #f1f5f9;
        color: #94a3b8;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Demand Level Badges */
    .badge-demand {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-demand.high {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
        color: var(--danger);
    }

    .badge-demand.medium {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
        color: var(--warning);
    }

    .badge-demand.low {
        
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
        color: var(--success);
    }

    .badge-demand i {
        font-size: 0.875rem;
    }

    /* Demand Display */
    .demand-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
    }

    /* Confidence Bar */
    .confidence-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .confidence-bar {
        flex: 1;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        min-width: 80px;
    }

    .confidence-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .confidence-fill.high {
        background: linear-gradient(90deg, var(--success), #34d399);
    }

    .confidence-fill.medium {
        background: linear-gradient(90deg, var(--warning), #fbbf24);
    }

    .confidence-fill.low {
        background: linear-gradient(90deg, var(--danger), #f87171);
    }

    .confidence-value {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--gray);
        min-width: 50px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: var(--gray);
        margin: 0;
    }

    /* Pagination Footer */
    .pagination-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--gray);
    }

    .pagination-nav {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .pagination-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        color: var(--gray);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(.disabled):not(.active) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .pagination-btn.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-color: transparent;
        color: white;
    }

    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
            border-radius: 1rem;
        }

        .page-header h1 {
            font-size: 1.5rem;
        }

        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-card-body {
            padding: 1rem;
        }

        .table-card-body {
            padding: 1rem;
        }

        .predictions-table {
            font-size: 0.85rem;
        }

        .predictions-table thead th,
        .predictions-table tbody td {
            padding: 0.75rem 0.5rem;
        }
    }

    @media (max-width: 576px) {
        .main-content .p-3,
        .main-content .p-md-4 {
            padding: 1rem !important;
        }

        .filter-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-reset {
            justify-content: center;
        }

        .pagination-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .pagination-footer {
            flex-direction: column;
            align-items: center;
        }
    }

    /* Scrollbar Styling */
    .dropdown-options::-webkit-scrollbar,
    .table-responsive::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .dropdown-options::-webkit-scrollbar-track,
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .dropdown-options::-webkit-scrollbar-thumb,
    .table-responsive::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .dropdown-options::-webkit-scrollbar-thumb:hover,
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

{% endblock style %}

{% block content %}
<!-- Main Content -->
<div class="col-lg-9 col-xl-10 main-content" id="mainContent">
    <div class="p-3 p-md-4">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <div>
                    <h1>
                        <i class="material-icons">assessment</i>
                        Prediction Results
                    </h1>
                    <p>View and analyze medicine demand predictions</p>
                </div>
                <div class="results-badge">
                    <i class="material-icons">analytics</i>
                    <span id="totalCount">{{ predictions|length }}</span> Results
                </div>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="filter-card">
            <div class="filter-card-header">
                <i class="material-icons">filter_alt</i>
                <h5>Filter Predictions</h5>
            </div>
            <div class="filter-card-body">
                <!-- Active Filter Tags -->
                <div class="filter-tags" id="activeFilterTags"></div>
                
                <!-- Filter Grid -->
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Medicine Name</label>
                        <div class="searchable-dropdown">
                            <button type="button" class="dropdown-toggle" id="medicineDropdown">
                                <span class="selected-text">All Medicines</span>
                            </button>
                            <div class="dropdown-menu" id="medicineDropdownMenu">
                                <div class="dropdown-search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search medicines..." id="medicineSearch">
                                </div>
                                <div class="dropdown-options" id="medicineOptions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Brand Name</label>
                        <div class="searchable-dropdown">
                            <button type="button" class="dropdown-toggle" id="brandDropdown">
                                <span class="selected-text">All Brands</span>
                            </button>
                            <div class="dropdown-menu" id="brandDropdownMenu">
                                <div class="dropdown-search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search brands..." id="brandSearch">
                                </div>
                                <div class="dropdown-options" id="brandOptions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <div class="searchable-dropdown">
                            <button type="button" class="dropdown-toggle" id="categoryDropdown">
                                <span class="selected-text">All Categories</span>
                            </button>
                            <div class="dropdown-menu" id="categoryDropdownMenu">
                                <div class="dropdown-search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search categories..." id="categorySearch">
                                </div>
                                <div class="dropdown-options" id="categoryOptions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Demand Level</label>
                        <div class="searchable-dropdown">
                            <button type="button" class="dropdown-toggle" id="demandLevelDropdown">
                                <span class="selected-text">All Levels</span>
                            </button>
                            <div class="dropdown-menu" id="demandLevelDropdownMenu">
                                <div class="dropdown-search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search levels..." id="demandLevelSearch">
                                </div>
                                <div class="dropdown-options" id="demandLevelOptions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Prediction Period</label>
                        <div class="searchable-dropdown">
                            <button type="button" class="dropdown-toggle" id="dateRangeDropdown">
                                <span class="selected-text">Select Period</span>
                            </button>
                            <div class="dropdown-menu" id="dateRangeDropdownMenu">
                                <div class="dropdown-search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search periods..." id="dateRangeSearch">
                                </div>
                                <div class="dropdown-options" id="dateRangeOptions"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Actions -->
                <div class="filter-actions">
                    <button type="button" class="btn-reset" id="resetFiltersBtn">
                        <i class="material-icons">refresh</i>
                        Reset All Filters
                    </button>
                    <div class="filter-count">
                        Showing <strong id="filteredCount">{{ predictions|length }}</strong> of <strong id="totalCount2">{{ predictions|length }}</strong> predictions
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions Table -->
        <div class="table-card">
            <div class="table-card-header">
                <div class="table-card-title">
                    <i class="material-icons">table_chart</i>
                    <h5>All Predictions</h5>
                </div>
            </div>
            <div class="table-card-body">
                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <div class="pagination-control-group">
                        <span>Show</span>
                        <select class="pagination-select" id="itemsPerPage">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="0">All</option>
                        </select>
                        <span>entries</span>
                    </div>
                    
                    <div class="pagination-control-group">
                        <span>Page</span>
                        <select class="pagination-select" id="pageSelector"></select>
                        <span>of <strong id="totalPages">1</strong></span>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="table-responsive">
                    <table class="predictions-table" id="predictionsTable">
                        <thead>
                            <tr>
                                <th>Medicine Name</th>
                                <th>Brand Name</th>
                                <th>Category</th>
                                <th>Prediction Range</th>
                                <th>Demand Level</th>
                                <th>Confidence Level</th>
                            </tr>
                        </thead>
                        <tbody id="predictionsTableBody">
                            {% for prediction in predictions %}
                            <tr class="prediction-row" 
                                data-medicine="{{ prediction.medicine_name|default_if_none:'' }}"
                                data-brand="{{ prediction.brand_name|default_if_none:'' }}"
                                data-category="{{ prediction.category|default_if_none:'' }}"
                                data-date-from="{{ prediction.date_from|date:'Y-m-d' }}"
                                data-date-to="{{ prediction.date_to|date:'Y-m-d' }}"
                                data-period="{{ prediction.date_from|date:'Y-m-d' }} to {{ prediction.date_to|date:'Y-m-d' }}"
                                data-demand-level="{{ prediction.predicted_demand|default_if_none:'' }}"
                                data-confidence="{{ prediction.confidence|default_if_none:0 }}">
                                <td>
                                    <strong>{{ prediction.medicine_name|default:"Not specified" }}</strong>
                                </td>
                                <td>
                                    {% if prediction.brand_name %}
                                    <span class="badge-brand">{{ prediction.brand_name }}</span>
                                    {% else %}
                                    <span class="badge-none">No brand</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if prediction.category %}
                                    <span class="badge-category">{{ prediction.category }}</span>
                                    {% else %}
                                    <span class="badge-none">Uncategorized</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ prediction.date_from|date:"M d, Y" }} - {{ prediction.date_to|date:"M d, Y" }}
                                </td>
                                <td>
                                    {% if prediction.predicted_demand %}
                                    <span class="badge-demand {% if prediction.predicted_demand == 'High' %}high{% elif prediction.predicted_demand == 'Medium' %}medium{% else %}low{% endif %}">
                                        <i class="material-icons">
                                            {% if prediction.predicted_demand == 'High' %}trending_up{% elif prediction.predicted_demand == 'Medium' %}trending_flat{% else %}trending_down{% endif %}
                                        </i>
                                        {{ prediction.predicted_demand }}
                                    </span>
                                    {% else %}
                                    <span class="badge-none">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if prediction.confidence %}
                                    <div class="confidence-wrapper">
                                        <div class="confidence-bar">
                                            <div class="confidence-fill {% if prediction.confidence >= 80 %}high{% elif prediction.confidence >= 50 %}medium{% else %}low{% endif %}" 
                                                 style="width: {{ prediction.confidence }}%"></div>
                                        </div>
                                        <span class="confidence-value">{{ prediction.confidence|floatformat:1 }}%</span>
                                    </div>
                                    {% else %}
                                    <span class="badge-none">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="empty-state-row">
                                <td colspan="6">
                                    <div class="empty-state">
                                        <i class="material-icons">search_off</i>
                                        <p>No prediction data available</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Footer -->
                <div class="pagination-footer">
                    <div class="pagination-info">
                        Showing <strong id="pageStart">1</strong> to <strong id="pageEnd">{{ predictions|length }}</strong> of <strong id="totalItems">{{ predictions|length }}</strong> entries
                    </div>
                    <div class="pagination-nav" id="paginationControls">
                        <!-- Pagination buttons will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
document.addEventListener('DOMContentLoaded', function() {
    // Get all prediction rows
    const allPredictionRows = Array.from(document.querySelectorAll('.prediction-row'));
    const totalCount = document.getElementById('totalCount');
    const totalCount2 = document.getElementById('totalCount2');
    const filteredCount = document.getElementById('filteredCount');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const activeFilterTags = document.getElementById('activeFilterTags');
    const itemsPerPage = document.getElementById('itemsPerPage');
    const pageSelector = document.getElementById('pageSelector');
    const totalPages = document.getElementById('totalPages');
    const pageStart = document.getElementById('pageStart');
    const pageEnd = document.getElementById('pageEnd');
    const totalItems = document.getElementById('totalItems');
    const paginationControls = document.getElementById('paginationControls');
    
    // Initialize variables
    let currentPage = 1;
    let itemsPerPageValue = parseInt(itemsPerPage.value);
    let filteredRows = [...allPredictionRows];
    let openDropdown = null;
    
    // Active filters object
    let activeFilters = {
        medicine: '',
        brand: '',
        category: '',
        demand_level: '',
        date_range: ''
    };
    
    // Helper function to format date: "2025-01-01" -> "Jan 01, 2025"
    function formatDateDisplay(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[date.getMonth()];
        const day = String(date.getDate()).padStart(2, '0');
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
    }
    
    // Helper function to format period display
    function formatPeriodDisplay(periodStr) {
        const parts = periodStr.split(' to ');
        if (parts.length === 2) {
            return `${formatDateDisplay(parts[0])} to ${formatDateDisplay(parts[1])}`;
        }
        return periodStr;
    }
    
    // Get unique values from rows for each filter
    const allMedicines = [...new Set(allPredictionRows.map(row => row.dataset.medicine))].filter(Boolean).sort();
    const allBrands = [...new Set(allPredictionRows.map(row => row.dataset.brand))].filter(Boolean).sort();
    const allCategories = [...new Set(allPredictionRows.map(row => row.dataset.category))].filter(Boolean).sort();
    const allDemandLevels = [...new Set(allPredictionRows.map(row => row.dataset.demandLevel))].filter(Boolean);
    
    // Get periods and sort by date (latest first)
    const allPeriodsRaw = [...new Set(allPredictionRows.map(row => row.dataset.period))].filter(Boolean);
    const allPeriods = allPeriodsRaw.sort((a, b) => {
        const dateA = new Date(a.split(' to ')[0]);
        const dateB = new Date(b.split(' to ')[0]);
        return dateB - dateA; // Latest first
    });
    
    // Sort demand levels in order: High, Medium, Low
    const demandLevelOrder = {'High': 1, 'Medium': 2, 'Low': 3};
    allDemandLevels.sort((a, b) => (demandLevelOrder[a] || 99) - (demandLevelOrder[b] || 99));
    
    // Initialize counts
    totalCount.textContent = allPredictionRows.length;
    totalCount2.textContent = allPredictionRows.length;
    totalItems.textContent = allPredictionRows.length;
    filteredCount.textContent = allPredictionRows.length;
    
    // Close all dropdowns
    function closeAllDropdowns(except = null) {
        document.querySelectorAll('.searchable-dropdown .dropdown-menu').forEach(menu => {
            if (!except || menu !== except) {
                menu.classList.remove('show');
            }
        });
        document.querySelectorAll('.searchable-dropdown .dropdown-toggle').forEach(toggle => {
            if (!except || toggle.nextElementSibling !== except) {
                toggle.classList.remove('active');
            }
        });
        document.querySelectorAll('.searchable-dropdown').forEach(dropdown => {
            if (!except || !dropdown.contains(except)) {
                dropdown.classList.remove('open');
            }
        });
    }
    
    // Initialize searchable dropdown
    function initializeDropdown(config) {
        const dropdownButton = document.getElementById(config.dropdownId);
        const dropdownMenu = document.getElementById(config.menuId);
        const optionsContainer = document.getElementById(config.optionsId);
        const searchInput = document.getElementById(config.searchId);
        const noAllOption = config.noAllOption || false;
        
        // If noAllOption and has options, auto-select first one
        if (noAllOption && config.options.length > 0) {
            activeFilters[config.filterKey] = config.options[0];
            // Set initial button text
            if (config.filterKey === 'date_range') {
                dropdownButton.querySelector('.selected-text').textContent = formatPeriodDisplay(config.options[0]);
            } else {
                dropdownButton.querySelector('.selected-text').textContent = config.options[0];
            }
        }
        
        function populateOptions(filter = '') {
            optionsContainer.innerHTML = '';
            
            // Add "All" option only if noAllOption is false
            if (!noAllOption) {
                const allOption = document.createElement('div');
                allOption.className = 'dropdown-option all-option' + (activeFilters[config.filterKey] === '' ? ' selected' : '');
                allOption.dataset.value = '';
                allOption.textContent = config.defaultText;
                allOption.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectOption('', config.defaultText);
                });
                optionsContainer.appendChild(allOption);
            }
            
            // Filter options based on search
            const searchLower = filter.toLowerCase();
            let filteredOptions = config.options;
            
            if (config.filterKey === 'date_range') {
                // Search in formatted display text for date ranges
                filteredOptions = config.options.filter(opt => 
                    formatPeriodDisplay(opt).toLowerCase().includes(searchLower)
                );
            } else {
                filteredOptions = config.options.filter(opt => 
                    opt.toLowerCase().includes(searchLower)
                );
            }
            
            if (filteredOptions.length === 0 && filter) {
                const emptyOption = document.createElement('div');
                emptyOption.className = 'dropdown-option empty';
                emptyOption.textContent = 'No options found';
                optionsContainer.appendChild(emptyOption);
            } else {
                filteredOptions.forEach(opt => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'dropdown-option' + (activeFilters[config.filterKey] === opt ? ' selected' : '');
                    optionElement.dataset.value = opt;
                    
                    // Special rendering for demand level
                    if (config.filterKey === 'demand_level') {
                        const levelClass = opt.toLowerCase();
                        const icon = opt === 'High' ? 'trending_up' : (opt === 'Medium' ? 'trending_flat' : 'trending_down');
                        optionElement.innerHTML = `
                            <span class="demand-option-badge ${levelClass}">
                                <i class="material-icons" style="font-size: 0.875rem;">${icon}</i>
                                ${opt}
                            </span>
                        `;
                    } else if (config.filterKey === 'date_range') {
                        // Format date range for display
                        optionElement.textContent = formatPeriodDisplay(opt);
                    } else {
                        optionElement.textContent = opt;
                    }
                    
                    optionElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectOption(opt, opt);
                    });
                    optionsContainer.appendChild(optionElement);
                });
            }
        }
        
        function selectOption(value, text) {
            // Update button text with special rendering
            if (config.filterKey === 'demand_level' && value) {
                const levelClass = value.toLowerCase();
                const icon = value === 'High' ? 'trending_up' : (value === 'Medium' ? 'trending_flat' : 'trending_down');
                dropdownButton.querySelector('.selected-text').innerHTML = `
                    <span class="demand-option-badge ${levelClass}">
                        <i class="material-icons" style="font-size: 0.875rem;">${icon}</i>
                        ${value}
                    </span>
                `;
            } else if (config.filterKey === 'date_range' && value) {
                dropdownButton.querySelector('.selected-text').textContent = formatPeriodDisplay(value);
            } else {
                dropdownButton.querySelector('.selected-text').textContent = value || config.defaultText;
            }
            
            // Update active filters
            activeFilters[config.filterKey] = value;
            
            // Close dropdown
            dropdownMenu.classList.remove('show');
            dropdownButton.classList.remove('active');
            dropdownButton.closest('.searchable-dropdown').classList.remove('open');
            openDropdown = null;
            
            // Clear search
            searchInput.value = '';
            
            // Apply filter
            filterPredictions();
        }
        
        // Search input handler
        searchInput.addEventListener('input', function() {
            populateOptions(this.value);
        });
        
        searchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Toggle dropdown
        dropdownButton.addEventListener('click', function(e) {
            e.stopPropagation();
            
            const dropdownContainer = this.closest('.searchable-dropdown');
            
            if (openDropdown === dropdownMenu) {
                dropdownMenu.classList.remove('show');
                dropdownButton.classList.remove('active');
                dropdownContainer.classList.remove('open');
                openDropdown = null;
            } else {
                closeAllDropdowns();
                dropdownMenu.classList.add('show');
                dropdownButton.classList.add('active');
                dropdownContainer.classList.add('open');
                openDropdown = dropdownMenu;
                searchInput.value = '';
                populateOptions();
                setTimeout(() => searchInput.focus(), 10);
            }
        });
        
        // Prevent menu clicks from closing
        dropdownMenu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Initialize options
        populateOptions();
        
        // Return reset function
        return function reset() {
            if (noAllOption && config.options.length > 0) {
                // Reset to first option for noAllOption dropdowns
                activeFilters[config.filterKey] = config.options[0];
                if (config.filterKey === 'date_range') {
                    dropdownButton.querySelector('.selected-text').textContent = formatPeriodDisplay(config.options[0]);
                } else {
                    dropdownButton.querySelector('.selected-text').textContent = config.options[0];
                }
            } else {
                activeFilters[config.filterKey] = '';
                dropdownButton.querySelector('.selected-text').textContent = config.defaultText;
            }
            searchInput.value = '';
            populateOptions();
        };
    }
    
    // Initialize all dropdowns
    const resetMedicine = initializeDropdown({
        dropdownId: 'medicineDropdown',
        menuId: 'medicineDropdownMenu',
        optionsId: 'medicineOptions',
        searchId: 'medicineSearch',
        options: allMedicines,
        defaultText: 'All Medicines',
        filterKey: 'medicine'
    });
    
    const resetBrand = initializeDropdown({
        dropdownId: 'brandDropdown',
        menuId: 'brandDropdownMenu',
        optionsId: 'brandOptions',
        searchId: 'brandSearch',
        options: allBrands,
        defaultText: 'All Brands',
        filterKey: 'brand'
    });
    
    const resetCategory = initializeDropdown({
        dropdownId: 'categoryDropdown',
        menuId: 'categoryDropdownMenu',
        optionsId: 'categoryOptions',
        searchId: 'categorySearch',
        options: allCategories,
        defaultText: 'All Categories',
        filterKey: 'category'
    });
    
    const resetDemandLevel = initializeDropdown({
        dropdownId: 'demandLevelDropdown',
        menuId: 'demandLevelDropdownMenu',
        optionsId: 'demandLevelOptions',
        searchId: 'demandLevelSearch',
        options: allDemandLevels.length > 0 ? allDemandLevels : ['High', 'Medium', 'Low'],
        defaultText: 'All Levels',
        filterKey: 'demand_level'
    });
    
    const resetDateRange = initializeDropdown({
        dropdownId: 'dateRangeDropdown',
        menuId: 'dateRangeDropdownMenu',
        optionsId: 'dateRangeOptions',
        searchId: 'dateRangeSearch',
        options: allPeriods,
        defaultText: 'Select Period',
        filterKey: 'date_range',
        noAllOption: true  // No "All Periods" option
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.searchable-dropdown')) {
            closeAllDropdowns();
            openDropdown = null;
        }
    });
    
    // Close on Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllDropdowns();
            openDropdown = null;
        }
    });
    
    // Update active filter tags
    function updateActiveFilterTags() {
        activeFilterTags.innerHTML = '';
        
        const filterNames = {
            medicine: 'Medicine',
            brand: 'Brand',
            category: 'Category',
            demand_level: 'Demand Level',
            date_range: 'Period'
        };
        
        Object.entries(activeFilters).forEach(([key, value]) => {
            if (value) {
                // Don't show date_range tag since it's always selected
                if (key === 'date_range') return;
                
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `
                    ${filterNames[key]}: ${value}
                    <span class="filter-tag-remove" data-filter="${key}">
                        <i class="material-icons">close</i>
                    </span>
                `;
                activeFilterTags.appendChild(tag);
            }
        });
        
        // Add remove handlers
        document.querySelectorAll('.filter-tag-remove').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterType = this.dataset.filter;
                clearSingleFilter(filterType);
            });
        });
    }
    
    // Clear single filter
    function clearSingleFilter(filterType) {
        switch(filterType) {
            case 'medicine':
                resetMedicine();
                break;
            case 'brand':
                resetBrand();
                break;
            case 'category':
                resetCategory();
                break;
            case 'demand_level':
                resetDemandLevel();
                break;
            case 'date_range':
                resetDateRange();
                break;
        }
        filterPredictions();
    }
    
    // Filter predictions
    function filterPredictions() {
        filteredRows = allPredictionRows.filter(row => {
            const medicine = row.dataset.medicine || '';
            const brand = row.dataset.brand || '';
            const category = row.dataset.category || '';
            const demandLevel = row.dataset.demandLevel || '';
            const period = row.dataset.period || '';
            
            // Check each filter
            if (activeFilters.medicine && medicine.toLowerCase() !== activeFilters.medicine.toLowerCase()) {
                return false;
            }
            if (activeFilters.brand && brand.toLowerCase() !== activeFilters.brand.toLowerCase()) {
                return false;
            }
            if (activeFilters.category && category.toLowerCase() !== activeFilters.category.toLowerCase()) {
                return false;
            }
            if (activeFilters.demand_level && demandLevel.toLowerCase() !== activeFilters.demand_level.toLowerCase()) {
                return false;
            }
            if (activeFilters.date_range && period !== activeFilters.date_range) {
                return false;
            }
            
            return true;
        });
        
        // Update count
        filteredCount.textContent = filteredRows.length;
        
        // Update tags
        updateActiveFilterTags();
        
        // Reset to first page
        currentPage = 1;
        
        // Update display
        updatePagination();
    }
    
    // Update pagination
    function updatePagination() {
        const totalFilteredItems = filteredRows.length;
        const totalPagesCount = itemsPerPageValue === 0 ? 1 : Math.max(1, Math.ceil(totalFilteredItems / itemsPerPageValue));
        
        // Ensure current page is valid
        if (currentPage > totalPagesCount) {
            currentPage = totalPagesCount;
        }
        
        // Update page selector
        pageSelector.innerHTML = '';
        for (let i = 1; i <= totalPagesCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === currentPage) option.selected = true;
            pageSelector.appendChild(option);
        }
        
        totalPages.textContent = totalPagesCount;
        
        // Calculate display range
        let startIndex, endIndex;
        if (itemsPerPageValue === 0 || totalFilteredItems === 0) {
            startIndex = totalFilteredItems === 0 ? 0 : 1;
            endIndex = totalFilteredItems;
        } else {
            startIndex = (currentPage - 1) * itemsPerPageValue + 1;
            endIndex = Math.min(currentPage * itemsPerPageValue, totalFilteredItems);
        }
        
        pageStart.textContent = startIndex;
        pageEnd.textContent = endIndex;
        totalItems.textContent = totalFilteredItems;
        
        // Update pagination buttons
        updatePaginationControls(totalPagesCount);
        
        // Show correct rows
        showCurrentPage();
    }
    
    // Update pagination controls
    function updatePaginationControls(totalPagesCount) {
        paginationControls.innerHTML = '';
        
        if (totalPagesCount <= 1) {
            return;
        }
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = `pagination-btn ${currentPage === 1 ? 'disabled' : ''}`;
        prevBtn.innerHTML = '<i class="material-icons" style="font-size: 1rem;">chevron_left</i>';
        if (currentPage > 1) {
            prevBtn.addEventListener('click', () => {
                currentPage--;
                updatePagination();
            });
        }
        paginationControls.appendChild(prevBtn);
        
        // Page numbers (show max 5)
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPagesCount, startPage + 4);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.addEventListener('click', () => {
                currentPage = i;
                updatePagination();
            });
            paginationControls.appendChild(pageBtn);
        }
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = `pagination-btn ${currentPage === totalPagesCount ? 'disabled' : ''}`;
        nextBtn.innerHTML = '<i class="material-icons" style="font-size: 1rem;">chevron_right</i>';
        if (currentPage < totalPagesCount) {
            nextBtn.addEventListener('click', () => {
                currentPage++;
                updatePagination();
            });
        }
        paginationControls.appendChild(nextBtn);
    }
    
    // Show current page rows
    function showCurrentPage() {
        // Hide all rows first
        allPredictionRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Calculate which rows to show
        let startIndex, endIndex;
        if (itemsPerPageValue === 0) {
            startIndex = 0;
            endIndex = filteredRows.length;
        } else {
            startIndex = (currentPage - 1) * itemsPerPageValue;
            endIndex = Math.min(currentPage * itemsPerPageValue, filteredRows.length);
        }
        
        // Show the rows for current page
        for (let i = startIndex; i < endIndex; i++) {
            if (filteredRows[i]) {
                filteredRows[i].style.display = '';
            }
        }
        
        // Handle empty state
        const tableBody = document.getElementById('predictionsTableBody');
        let emptyRow = tableBody.querySelector('.empty-state-row');
        
        if (filteredRows.length === 0) {
            if (!emptyRow) {
                emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-state-row';
                emptyRow.innerHTML = `
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="material-icons">search_off</i>
                            <p>No predictions match your filters</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
            }
            emptyRow.style.display = '';
        } else if (emptyRow) {
            emptyRow.style.display = 'none';
        }
    }
    
    // Items per page change
    itemsPerPage.addEventListener('change', function() {
        itemsPerPageValue = this.value === '0' ? 0 : parseInt(this.value);
        currentPage = 1;
        updatePagination();
    });
    
    // Page selector change
    pageSelector.addEventListener('change', function() {
        currentPage = parseInt(this.value);
        updatePagination();
    });
    
    // Reset all filters
    resetFiltersBtn.addEventListener('click', function() {
        resetMedicine();
        resetBrand();
        resetCategory();
        resetDemandLevel();
        resetDateRange();
        filterPredictions();
    });
    
    // Initialize display with filters applied
    filterPredictions();
});
{% endblock script %}