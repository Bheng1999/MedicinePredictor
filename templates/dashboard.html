{% extends "navsidebar.html" %}

{% block title %}
    MediPredict | Dashboard
{% endblock title %}

{% block style %}
:root {
    --primary: #4a6cf7;
    --primary-dark: #3a5ce5;
    --primary-light: #6b8cff;
    --secondary: #764ba2;
    --dark: #1a1a2e;
    --gray: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
}

.page-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 1.5rem;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}

.page-header h1 { font-size: 1.75rem; font-weight: 700; margin: 0; position: relative; z-index: 1; }
.page-header p { margin: 0.5rem 0 0; opacity: 0.9; position: relative; z-index: 1; }

.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 576px) { .stats-grid { grid-template-columns: 1fr; } }

.stat-card {
    background: white;
    border-radius: 1.25rem;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12); }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 1.25rem 1.25rem 0 0; }
.stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
.stat-card.success::before { background: linear-gradient(90deg, var(--success), #34d399); }
.stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #fbbf24); }
.stat-card.info::before { background: linear-gradient(90deg, var(--info), #22d3ee); }

.stat-card-content { display: flex; justify-content: space-between; align-items: flex-start; }
.stat-card-info h3 { font-size: 0.875rem; font-weight: 600; color: var(--gray); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card-value { font-size: 2rem; font-weight: 800; color: var(--dark); line-height: 1; }
.stat-card-trend { display: flex; align-items: center; gap: 0.25rem; margin-top: 0.75rem; font-size: 0.8rem; font-weight: 600; }
.stat-card-trend.up { color: var(--success); }

.stat-card-icon { width: 60px; height: 60px; border-radius: 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.stat-card-icon i { font-size: 1.75rem; color: white; }
.stat-card.primary .stat-card-icon { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }
.stat-card.success .stat-card-icon { background: linear-gradient(135deg, var(--success), #34d399); }
.stat-card.warning .stat-card-icon { background: linear-gradient(135deg, var(--warning), #fbbf24); }
.stat-card.info .stat-card-icon { background: linear-gradient(135deg, var(--info), #22d3ee); }

.chart-card { background: white; border-radius: 1.25rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden; margin-bottom: 1.5rem; }
.chart-card-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
.chart-card-title { font-size: 1.1rem; font-weight: 700; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 0.5rem; }
.chart-card-title i { color: var(--primary); }
.chart-card-body { padding: 1.5rem; }

.filters-section { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; }
.filters-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
@media (max-width: 1400px) { .filters-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 992px) { .filters-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 576px) { .filters-grid { grid-template-columns: 1fr; } }

.filter-group { display: flex; flex-direction: column; }
.filter-label { font-size: 0.8rem; font-weight: 600; color: var(--gray); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }

.searchable-dropdown { position: relative; }
.searchable-dropdown .dropdown-toggle { width: 100%; padding: 0.75rem 1rem; background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.9rem; color: var(--dark); cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s ease; }
.searchable-dropdown .dropdown-toggle:hover { border-color: var(--primary); }
.searchable-dropdown .dropdown-toggle:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1); outline: none; }
.searchable-dropdown .dropdown-toggle::after { content: '\e5cf'; font-family: 'Material Icons'; font-size: 1.25rem; color: var(--gray); transition: transform 0.3s ease; }
.searchable-dropdown .dropdown-toggle.active::after { transform: rotate(180deg); }
.searchable-dropdown .selected-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

.searchable-dropdown .dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; margin-top: 0.5rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); z-index: 1000; display: none; max-height: 300px; overflow: hidden; }
.searchable-dropdown .dropdown-menu.show { display: block; animation: dropdownFade 0.2s ease; }
@keyframes dropdownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.searchable-dropdown .dropdown-search-container { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
.searchable-dropdown .dropdown-search { width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.875rem; }
.searchable-dropdown .dropdown-search:focus { outline: none; border-color: var(--primary); }
.searchable-dropdown .dropdown-options { max-height: 220px; overflow-y: auto; }
.searchable-dropdown .dropdown-option { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 0.5rem; }
.searchable-dropdown .dropdown-option:hover { background-color: #f8fafc; }
.searchable-dropdown .dropdown-option.selected { background: linear-gradient(135deg, rgba(74, 108, 247, 0.1), rgba(118, 75, 162, 0.1)); color: var(--primary); font-weight: 600; }
.searchable-dropdown .dropdown-option.all-option { font-weight: 600; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
.searchable-dropdown .dropdown-option.empty { color: var(--gray); font-style: italic; text-align: center; padding: 1rem; }

.demand-indicator { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.demand-indicator.high { background: var(--danger); }
.demand-indicator.medium { background: var(--warning); }
.demand-indicator.low { background: var(--success); }

.filter-actions { display: flex; justify-content: flex-end; margin-top: 1rem; }
.btn-reset { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600; color: var(--gray); cursor: pointer; transition: all 0.3s ease; }
.btn-reset:hover { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.05); }

.filter-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 36px; }
.filter-tag { display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, rgba(74, 108, 247, 0.1), rgba(118, 75, 162, 0.1)); color: var(--primary); border: 1px solid rgba(74, 108, 247, 0.2); border-radius: 50px; padding: 0.375rem 0.75rem 0.375rem 1rem; font-size: 0.8rem; font-weight: 600; }
.filter-tag.high { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
.filter-tag.medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }
.filter-tag.low { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
.filter-tag-remove { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; background: rgba(74, 108, 247, 0.2); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; }
.filter-tag-remove:hover { background: var(--danger); color: white; }
.filter-tag-remove i { font-size: 0.875rem; }

.chart-container { position: relative; height: 400px; }
.chart-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--gray); }
.chart-empty i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
.chart-empty p { margin: 0; font-size: 1rem; }
.chart-empty small { margin-top: 0.5rem; opacity: 0.7; }

.chart-note { text-align: center; padding: 1rem; background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(74, 108, 247, 0.1)); border-radius: 0.75rem; margin-top: 1rem; }
.chart-note i { color: var(--info); vertical-align: middle; margin-right: 0.25rem; }
.chart-note small { color: var(--gray); }

.stats-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
@media (max-width: 992px) { .stats-section { grid-template-columns: 1fr; } }
.pie-chart-container { height: 300px; }

.demand-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.demand-stat-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 1rem; padding: 1.25rem; text-align: center; transition: all 0.3s ease; border: 1px solid transparent; }
.demand-stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
.demand-stat-card.high { border-color: rgba(239, 68, 68, 0.3); }
.demand-stat-card.medium { border-color: rgba(245, 158, 11, 0.3); }
.demand-stat-card.low { border-color: rgba(16, 185, 129, 0.3); }
.demand-stat-card.total { border-color: rgba(74, 108, 247, 0.3); }
.demand-stat-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
.demand-stat-card.high .demand-stat-label { color: var(--danger); }
.demand-stat-card.medium .demand-stat-label { color: var(--warning); }
.demand-stat-card.low .demand-stat-label { color: var(--success); }
.demand-stat-card.total .demand-stat-label { color: var(--primary); }
.demand-stat-value { font-size: 1.75rem; font-weight: 800; color: var(--dark); line-height: 1; margin-bottom: 0.25rem; }
.demand-stat-count { font-size: 0.75rem; color: var(--gray); }

.demand-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.demand-badge.high { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
.demand-badge.medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.demand-badge.low { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.demand-badge.all { background: rgba(74, 108, 247, 0.1); color: var(--primary); }

.section-title { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
.section-title i { color: var(--primary); }

.dropdown-options::-webkit-scrollbar { width: 6px; }
.dropdown-options::-webkit-scrollbar-track { background: #f1f5f9; }
.dropdown-options::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

@media (max-width: 768px) {
    .page-header { padding: 1.5rem; border-radius: 1rem; }
    .page-header h1 { font-size: 1.5rem; }
    .stat-card { padding: 1.25rem; }
    .stat-card-value { font-size: 1.5rem; }
    .stat-card-icon { width: 50px; height: 50px; }
    .stat-card-icon i { font-size: 1.5rem; }
    .chart-card-header, .chart-card-body { padding: 1rem; }
    .filters-section { padding: 1rem; }
    .chart-container { height: 300px; }
    .pie-chart-container { height: 250px; }
    .demand-stats-grid { grid-template-columns: 1fr; }
}
{% endblock style %}

{% block content %}
<div class="col-lg-9 col-xl-10 main-content" id="mainContent">
    <div class="p-3 p-md-4">
        <div class="page-header">
            <h1><i class="material-icons align-middle me-2">dashboard</i> Dashboard</h1>
            <p>Welcome back! Here's an overview of your pharmacy predictions.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>Datasets</h3>
                        <div class="stat-card-value">{{ datasets_count }}</div>
                        <div class="stat-card-trend up"><i class="material-icons">trending_up</i><span>Active</span></div>
                    </div>
                    <div class="stat-card-icon"><i class="material-icons">dataset</i></div>
                </div>
            </div>
            <div class="stat-card success">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>Trained Models</h3>
                        <div class="stat-card-value">{{ trained_models_count }}</div>
                        <div class="stat-card-trend up"><i class="material-icons">check_circle</i><span>Ready</span></div>
                    </div>
                    <div class="stat-card-icon"><i class="material-icons">model_training</i></div>
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>Predictions</h3>
                        <div class="stat-card-value">{{ predictions_count }}</div>
                        <div class="stat-card-trend up"><i class="material-icons">insights</i><span>Generated</span></div>
                    </div>
                    <div class="stat-card-icon"><i class="material-icons">psychology</i></div>
                </div>
            </div>
            <div class="stat-card info">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>Model Accuracy</h3>
                        <div class="stat-card-value">{{ accuracy }}%</div>
                        <div class="stat-card-trend up"><i class="material-icons">verified</i><span>Verified</span></div>
                    </div>
                    <div class="stat-card-icon"><i class="material-icons">bar_chart</i></div>
                </div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-card-header">
                <h5 class="chart-card-title"><i class="material-icons">trending_up</i> Medicine Demand Predictions</h5>
                <span class="demand-badge all" id="demandBadge">All Levels</span>
            </div>
            <div class="chart-card-body">
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Medicine Name</label>
                            <div class="searchable-dropdown">
                                <button type="button" class="dropdown-toggle" id="medicineDropdown"><span class="selected-text">All Medicines</span></button>
                                <div class="dropdown-menu" id="medicineDropdownMenu">
                                    <div class="dropdown-search-container"><input type="text" class="dropdown-search" placeholder="Search medicines..." id="medicineSearch"></div>
                                    <div class="dropdown-options" id="medicineOptions"></div>
                                </div>
                                <input type="hidden" id="medicineFilter" value="">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Category</label>
                            <div class="searchable-dropdown">
                                <button type="button" class="dropdown-toggle" id="categoryDropdown"><span class="selected-text">All Categories</span></button>
                                <div class="dropdown-menu" id="categoryDropdownMenu">
                                    <div class="dropdown-search-container"><input type="text" class="dropdown-search" placeholder="Search categories..." id="categorySearch"></div>
                                    <div class="dropdown-options" id="categoryOptions"></div>
                                </div>
                                <input type="hidden" id="categoryFilter" value="">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Brand</label>
                            <div class="searchable-dropdown">
                                <button type="button" class="dropdown-toggle" id="brandDropdown"><span class="selected-text">All Brands</span></button>
                                <div class="dropdown-menu" id="brandDropdownMenu">
                                    <div class="dropdown-search-container"><input type="text" class="dropdown-search" placeholder="Search brands..." id="brandSearch"></div>
                                    <div class="dropdown-options" id="brandOptions"></div>
                                </div>
                                <input type="hidden" id="brandFilter" value="">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Demand Level</label>
                            <div class="searchable-dropdown">
                                <button type="button" class="dropdown-toggle" id="demandLevelDropdown"><span class="selected-text">All Levels</span></button>
                                <div class="dropdown-menu" id="demandLevelDropdownMenu">
                                    <div class="dropdown-options" id="demandLevelOptions"></div>
                                </div>
                                <input type="hidden" id="demandLevelFilter" value="">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Prediction Period</label>
                            <div class="searchable-dropdown">
                                <button type="button" class="dropdown-toggle" id="dateRangeDropdown"><span class="selected-text">Select Period</span></button>
                                <div class="dropdown-menu" id="dateRangeDropdownMenu">
                                    <div class="dropdown-search-container"><input type="text" class="dropdown-search" placeholder="Search periods..." id="dateRangeSearch"></div>
                                    <div class="dropdown-options" id="dateRangeOptions"></div>
                                </div>
                                <input type="hidden" id="dateRangeFilter" value="">
                            </div>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button type="button" class="btn-reset" id="resetChartFiltersBtn"><i class="material-icons">refresh</i> Reset Filters</button>
                    </div>
                </div>
                <div class="filter-tags" id="chartFilterTags"></div>
                <div class="chart-container"><canvas id="medicinesBarChart"></canvas></div>
                <div class="chart-note"><i class="material-icons">info</i><small id="chartNoteText">Showing all demand levels. Use the Demand Level filter to narrow results.</small></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-card-header">
                <h5 class="chart-card-title"><i class="material-icons">pie_chart</i> Prediction Demand Distribution</h5>
            </div>
            <div class="chart-card-body">
                <div class="stats-section">
                    <div><div class="pie-chart-container"><canvas id="demandPieChart"></canvas></div></div>
                    <div>
                        <h6 class="section-title"><i class="material-icons">analytics</i> Prediction Statistics</h6>
                        <div class="demand-stats-grid">
                            <div class="demand-stat-card high">
                                <div class="demand-stat-label">High Demand</div>
                                <div class="demand-stat-value" id="highDemandPercent">{{ high_demand_percent }}%</div>
                                <div class="demand-stat-count" id="highDemandCount">{{ high_demand_count }} predictions</div>
                            </div>
                            <div class="demand-stat-card medium">
                                <div class="demand-stat-label">Medium Demand</div>
                                <div class="demand-stat-value" id="mediumDemandPercent">{{ medium_demand_percent }}%</div>
                                <div class="demand-stat-count" id="mediumDemandCount">{{ medium_demand_count }} predictions</div>
                            </div>
                            <div class="demand-stat-card low">
                                <div class="demand-stat-label">Low Demand</div>
                                <div class="demand-stat-value" id="lowDemandPercent">{{ low_demand_percent }}%</div>
                                <div class="demand-stat-count" id="lowDemandCount">{{ low_demand_count }} predictions</div>
                            </div>
                            <div class="demand-stat-card total">
                                <div class="demand-stat-label">Total Predictions</div>
                                <div class="demand-stat-value" id="totalPredictions">{{ predictions_count }}</div>
                                <div class="demand-stat-count" id="filterStatus">All predictions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
document.addEventListener('DOMContentLoaded', function() {
    const resetChartFiltersBtn = document.getElementById('resetChartFiltersBtn');
    const chartFilterTags = document.getElementById('chartFilterTags');
    const demandBadge = document.getElementById('demandBadge');
    const chartNoteText = document.getElementById('chartNoteText');
    
    const highDemandPercentEl = document.getElementById('highDemandPercent');
    const highDemandCountEl = document.getElementById('highDemandCount');
    const mediumDemandPercentEl = document.getElementById('mediumDemandPercent');
    const mediumDemandCountEl = document.getElementById('mediumDemandCount');
    const lowDemandPercentEl = document.getElementById('lowDemandPercent');
    const lowDemandCountEl = document.getElementById('lowDemandCount');
    const totalPredictionsEl = document.getElementById('totalPredictions');
    const filterStatusEl = document.getElementById('filterStatus');
    
    const predictionData = {{ prediction_data|safe }};
    const demandLevels = ['High', 'Medium', 'Low'];
    const demandColors = {
        'High': { bg: 'rgba(239, 68, 68, 0.8)', border: 'rgb(239, 68, 68)' },
        'Medium': { bg: 'rgba(245, 158, 11, 0.8)', border: 'rgb(245, 158, 11)' },
        'Low': { bg: 'rgba(16, 185, 129, 0.8)', border: 'rgb(16, 185, 129)' }
    };
    
    function formatDateDisplay(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[date.getMonth()]} ${String(date.getDate()).padStart(2, '0')}, ${date.getFullYear()}`;
    }
    
    function formatPeriodDisplay(periodStr) {
        if (!periodStr) return '';
        const parts = periodStr.split(' to ');
        return parts.length === 2 ? `${formatDateDisplay(parts[0])} to ${formatDateDisplay(parts[1])}` : periodStr;
    }
    
    const allMedicineNames = [...new Set(predictionData.map(m => m.name))].filter(Boolean).sort();
    const allCategories = [...new Set(predictionData.map(m => m.category))].filter(Boolean).sort();
    const allBrands = [...new Set(predictionData.map(m => m.brand))].filter(Boolean).sort();
    const allDateRanges = [...new Set(predictionData.map(m => m.period))].filter(Boolean).sort((a, b) => new Date(b.split(' to ')[0]) - new Date(a.split(' to ')[0]));
    
    let medicinesBarChart = null, demandPieChart = null;
    let activeFilters = { medicine: '', category: '', brand: '', demand_level: '', date_range: allDateRanges.length > 0 ? allDateRanges[0] : '' };
    
    const dropdownConfigs = {
        medicine: { dropdownId: 'medicineDropdown', menuId: 'medicineDropdownMenu', optionsId: 'medicineOptions', searchId: 'medicineSearch', hiddenInputId: 'medicineFilter', options: allMedicineNames, defaultText: 'All Medicines', hasAllOption: true, hasSearch: true },
        category: { dropdownId: 'categoryDropdown', menuId: 'categoryDropdownMenu', optionsId: 'categoryOptions', searchId: 'categorySearch', hiddenInputId: 'categoryFilter', options: allCategories, defaultText: 'All Categories', hasAllOption: true, hasSearch: true },
        brand: { dropdownId: 'brandDropdown', menuId: 'brandDropdownMenu', optionsId: 'brandOptions', searchId: 'brandSearch', hiddenInputId: 'brandFilter', options: allBrands, defaultText: 'All Brands', hasAllOption: true, hasSearch: true },
        demand_level: { dropdownId: 'demandLevelDropdown', menuId: 'demandLevelDropdownMenu', optionsId: 'demandLevelOptions', searchId: null, hiddenInputId: 'demandLevelFilter', options: demandLevels, defaultText: 'All Levels', hasAllOption: true, hasSearch: false },
        date_range: { dropdownId: 'dateRangeDropdown', menuId: 'dateRangeDropdownMenu', optionsId: 'dateRangeOptions', searchId: 'dateRangeSearch', hiddenInputId: 'dateRangeFilter', options: allDateRanges, defaultText: 'Select Period', hasAllOption: false, hasSearch: true, formatDisplay: formatPeriodDisplay }
    };
    
    let currentOpenDropdown = null;
    
    function closeDropdown(filterKey) { const c = dropdownConfigs[filterKey]; document.getElementById(c.menuId).classList.remove('show'); document.getElementById(c.dropdownId).classList.remove('active'); }
    function closeAllDropdowns() { Object.keys(dropdownConfigs).forEach(k => closeDropdown(k)); currentOpenDropdown = null; }
    
    function openDropdown(filterKey) {
        closeAllDropdowns();
        const c = dropdownConfigs[filterKey];
        document.getElementById(c.menuId).classList.add('show');
        document.getElementById(c.dropdownId).classList.add('active');
        currentOpenDropdown = filterKey;
        if (c.hasSearch && c.searchId) { const s = document.getElementById(c.searchId); s.value = ''; setTimeout(() => s.focus(), 50); }
        populateDropdownOptions(filterKey, '');
    }
    
    function toggleDropdown(filterKey) { currentOpenDropdown === filterKey ? closeAllDropdowns() : openDropdown(filterKey); }
    
    function populateDropdownOptions(filterKey, searchTerm) {
        const c = dropdownConfigs[filterKey], container = document.getElementById(c.optionsId), currentValue = activeFilters[filterKey], formatFn = c.formatDisplay || (v => v);
        container.innerHTML = '';
        if (c.hasAllOption) { const allOpt = document.createElement('div'); allOpt.className = 'dropdown-option all-option' + (currentValue === '' ? ' selected' : ''); allOpt.textContent = c.defaultText; allOpt.onclick = (e) => { e.preventDefault(); e.stopPropagation(); selectFilterValue(filterKey, ''); }; container.appendChild(allOpt); }
        let filteredOptions = c.options;
        if (searchTerm) { const sl = searchTerm.toLowerCase(); filteredOptions = c.options.filter(o => formatFn(o).toLowerCase().includes(sl) || o.toLowerCase().includes(sl)); }
        if (filteredOptions.length === 0) { const empty = document.createElement('div'); empty.className = 'dropdown-option empty'; empty.textContent = 'No options found'; container.appendChild(empty); }
        else { filteredOptions.forEach(opt => { const el = document.createElement('div'); el.className = 'dropdown-option' + (currentValue === opt ? ' selected' : ''); if (filterKey === 'demand_level') { const ind = document.createElement('span'); ind.className = `demand-indicator ${opt.toLowerCase()}`; el.appendChild(ind); } const txt = document.createElement('span'); txt.textContent = formatFn(opt); el.appendChild(txt); el.onclick = (e) => { e.preventDefault(); e.stopPropagation(); selectFilterValue(filterKey, opt); }; container.appendChild(el); }); }
    }
    
    function selectFilterValue(filterKey, value) {
        const c = dropdownConfigs[filterKey], formatFn = c.formatDisplay || (v => v);
        activeFilters[filterKey] = value;
        document.getElementById(c.hiddenInputId).value = value;
        document.getElementById(c.dropdownId).querySelector('.selected-text').textContent = value === '' ? c.defaultText : formatFn(value);
        closeAllDropdowns();
        if (filterKey === 'demand_level') updateDemandBadge(value);
        updateCharts();
    }
    
    function updateDemandBadge(level) {
        demandBadge.className = 'demand-badge';
        if (level === '') { demandBadge.classList.add('all'); demandBadge.textContent = 'All Levels'; chartNoteText.textContent = 'Showing all demand levels. Use the Demand Level filter to narrow results.'; }
        else { demandBadge.classList.add(level.toLowerCase()); demandBadge.textContent = `${level} Demand Only`; chartNoteText.textContent = `Showing only ${level} Demand predictions (predicted demand level: ${level})`; }
    }
    
    function resetFilter(filterKey) { const c = dropdownConfigs[filterKey]; if (filterKey === 'date_range' && allDateRanges.length > 0) selectFilterValue(filterKey, allDateRanges[0]); else if (c.hasAllOption) selectFilterValue(filterKey, ''); }
    
    function initializeDropdowns() {
        Object.keys(dropdownConfigs).forEach(filterKey => {
            const c = dropdownConfigs[filterKey], button = document.getElementById(c.dropdownId), menu = document.getElementById(c.menuId), formatFn = c.formatDisplay || (v => v);
            if (filterKey === 'date_range' && allDateRanges.length > 0) { activeFilters[filterKey] = allDateRanges[0]; document.getElementById(c.hiddenInputId).value = allDateRanges[0]; button.querySelector('.selected-text').textContent = formatFn(allDateRanges[0]); }
            button.onclick = (e) => { e.preventDefault(); e.stopPropagation(); toggleDropdown(filterKey); };
            if (c.hasSearch && c.searchId) { const s = document.getElementById(c.searchId); s.oninput = function() { populateDropdownOptions(filterKey, this.value); }; s.onclick = (e) => e.stopPropagation(); }
            menu.onclick = (e) => e.stopPropagation();
            populateDropdownOptions(filterKey, '');
        });
        document.addEventListener('click', (e) => { if (!e.target.closest('.searchable-dropdown')) closeAllDropdowns(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAllDropdowns(); });
    }
    
    function updateChartFilterTags() {
        chartFilterTags.innerHTML = '';
        const filterNames = { medicine: 'Medicine', category: 'Category', brand: 'Brand', demand_level: 'Demand', date_range: 'Period' };
        Object.entries(activeFilters).forEach(([key, value]) => {
            if (!value || key === 'date_range') return;
            const tag = document.createElement('div'); tag.className = 'filter-tag'; if (key === 'demand_level') tag.classList.add(value.toLowerCase());
            tag.innerHTML = `${filterNames[key]}: ${value}<span class="filter-tag-remove" data-filter="${key}"><i class="material-icons">close</i></span>`;
            chartFilterTags.appendChild(tag);
            tag.querySelector('.filter-tag-remove').onclick = function() { resetFilter(this.dataset.filter); };
        });
    }
    
    function filterPredictionData() {
        return predictionData.filter(p => {
            if (activeFilters.medicine && p.name !== activeFilters.medicine) return false;
            if (activeFilters.category && p.category !== activeFilters.category) return false;
            if (activeFilters.brand && p.brand !== activeFilters.brand) return false;
            if (activeFilters.demand_level && p.predicted_level !== activeFilters.demand_level) return false;
            if (activeFilters.date_range && p.period !== activeFilters.date_range) return false;
            return true;
        }).sort((a, b) => b.demand - a.demand);
    }
    
    function filterAllPredictionDataForPie() {
        return predictionData.filter(p => {
            if (activeFilters.medicine && p.name !== activeFilters.medicine) return false;
            if (activeFilters.category && p.category !== activeFilters.category) return false;
            if (activeFilters.brand && p.brand !== activeFilters.brand) return false;
            if (activeFilters.date_range && p.period !== activeFilters.date_range) return false;
            return true;
        });
    }
    
    function updateStatistics(filteredData) {
        const highDemand = filteredData.filter(p => p.predicted_level === 'High').length;
        const mediumDemand = filteredData.filter(p => p.predicted_level === 'Medium').length;
        const lowDemand = filteredData.filter(p => p.predicted_level === 'Low').length;
        const total = highDemand + mediumDemand + lowDemand;
        const highPercent = total > 0 ? Math.round((highDemand / total) * 100) : 0;
        const mediumPercent = total > 0 ? Math.round((mediumDemand / total) * 100) : 0;
        const lowPercent = total > 0 ? Math.round((lowDemand / total) * 100) : 0;
        highDemandCountEl.textContent = `${highDemand} predictions`; highDemandPercentEl.textContent = `${highPercent}%`;
        mediumDemandCountEl.textContent = `${mediumDemand} predictions`; mediumDemandPercentEl.textContent = `${mediumPercent}%`;
        lowDemandCountEl.textContent = `${lowDemand} predictions`; lowDemandPercentEl.textContent = `${lowPercent}%`;
        totalPredictionsEl.textContent = total;
        filterStatusEl.textContent = Object.entries(activeFilters).filter(([k, v]) => k !== 'date_range' && v).length === 0 ? 'Filtered by period' : 'Filtered predictions';
        return { highDemand, mediumDemand, lowDemand, total };
    }
    
    function updateBarChart() {
        const filteredData = filterPredictionData(), chartData = filteredData.slice(0, 20);
        if (medicinesBarChart) { medicinesBarChart.destroy(); medicinesBarChart = null; }
        const chartContainer = document.querySelector('.chart-container');
        if (!document.getElementById('medicinesBarChart')) chartContainer.innerHTML = '<canvas id="medicinesBarChart"></canvas>';
        const canvas = document.getElementById('medicinesBarChart');
        if (chartData.length === 0) { chartContainer.innerHTML = `<div class="chart-empty"><i class="material-icons">bar_chart</i><p>No predictions available</p><small>Try adjusting your filters</small></div>`; return; }
        const ctx = canvas.getContext('2d');
        const chartLabels = chartData.map(p => (p.brand && p.brand !== 'Unknown' && p.brand !== 'Generic') ? p.brand : p.name);
        const backgroundColors = chartData.map(p => demandColors[p.predicted_level]?.bg || demandColors['High'].bg);
        const borderColors = chartData.map(p => demandColors[p.predicted_level]?.border || demandColors['High'].border);
        medicinesBarChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: chartLabels, datasets: [{ label: 'Demand Predictions', data: chartData.map(p => p.demand), backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 2, borderRadius: 8, borderSkipped: false }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(26, 26, 46, 0.95)', titleColor: '#fff', bodyColor: '#e2e8f0', cornerRadius: 12, padding: 16, callbacks: { label: function(context) { const p = chartData[context.dataIndex]; return [`Medicine: ${p.name}`, `Category: ${p.category}`, `Brand: ${p.brand}`, `Demand Level: ${p.predicted_level}`, `Demand: ${p.demand.toLocaleString()} units`, `Confidence: ${p.confidence.toFixed(2)}%`, `Period: ${formatPeriodDisplay(p.period)}`]; } } } },
                scales: { y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, title: { display: true, text: 'Predicted Demand (units)', font: { size: 12, weight: '600' }, color: '#64748b' }, ticks: { callback: v => v.toLocaleString(), font: { size: 11 }, color: '#64748b' } }, x: { grid: { display: false }, title: { display: true, text: 'Medicines (with Brand)', font: { size: 12, weight: '600' }, color: '#64748b' }, ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 }, color: '#64748b', callback: function(v) { const l = this.getLabelForValue(v); return l.length > 15 ? l.substring(0, 15) + '...' : l; } } } }
            }
        });
    }
    
    function updatePieChart() {
        const filteredData = filterAllPredictionDataForPie();
        const { highDemand, mediumDemand, lowDemand, total } = updateStatistics(filteredData);
        if (demandPieChart) { demandPieChart.destroy(); demandPieChart = null; }
        const pieContainer = document.querySelector('.pie-chart-container');
        if (!document.getElementById('demandPieChart')) pieContainer.innerHTML = '<canvas id="demandPieChart"></canvas>';
        const canvas = document.getElementById('demandPieChart');
        if (total === 0) { pieContainer.innerHTML = `<div class="chart-empty"><i class="material-icons">pie_chart</i><p>No prediction data available</p><small>Try adjusting your filters</small></div>`; return; }
        const ctx = canvas.getContext('2d');
        demandPieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['High Demand', 'Medium Demand', 'Low Demand'], datasets: [{ data: [highDemand, mediumDemand, lowDemand], backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)'], borderColor: ['rgb(239, 68, 68)', 'rgb(245, 158, 11)', 'rgb(16, 185, 129)'], borderWidth: 3, hoverOffset: 10 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, pointStyle: 'circle', font: { size: 12, weight: '600' } } }, tooltip: { backgroundColor: 'rgba(26, 26, 46, 0.95)', titleColor: '#fff', bodyColor: '#e2e8f0', cornerRadius: 12, padding: 16, callbacks: { label: function(context) { const v = context.raw || 0, t = context.dataset.data.reduce((a, b) => a + b, 0), p = t > 0 ? Math.round((v / t) * 100) : 0; return `${p}% (${v} predictions)`; } } } } }
        });
    }
    
    function updateCharts() { updateBarChart(); updatePieChart(); updateChartFilterTags(); }
    
    resetChartFiltersBtn.onclick = function() {
        activeFilters.medicine = ''; document.getElementById('medicineFilter').value = ''; document.getElementById('medicineDropdown').querySelector('.selected-text').textContent = 'All Medicines';
        activeFilters.category = ''; document.getElementById('categoryFilter').value = ''; document.getElementById('categoryDropdown').querySelector('.selected-text').textContent = 'All Categories';
        activeFilters.brand = ''; document.getElementById('brandFilter').value = ''; document.getElementById('brandDropdown').querySelector('.selected-text').textContent = 'All Brands';
        activeFilters.demand_level = ''; document.getElementById('demandLevelFilter').value = ''; document.getElementById('demandLevelDropdown').querySelector('.selected-text').textContent = 'All Levels'; updateDemandBadge('');
        if (allDateRanges.length > 0) { activeFilters.date_range = allDateRanges[0]; document.getElementById('dateRangeFilter').value = allDateRanges[0]; document.getElementById('dateRangeDropdown').querySelector('.selected-text').textContent = formatPeriodDisplay(allDateRanges[0]); }
        updateCharts();
    };
    
    initializeDropdowns(); updateCharts();
    window.addEventListener('resize', function() { if (medicinesBarChart) medicinesBarChart.resize(); if (demandPieChart) demandPieChart.resize(); });
});
{% endblock script %}